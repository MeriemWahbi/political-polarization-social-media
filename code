# ----------------------------
# Projet : Polarisation politique sur les réseaux
# ----------------------------

## Chargement des librairies

library(tidyverse)
library(tidytext)
library(lubridate)
library(readxl)
library(GGally)

## Importation et nettoyage des données Twitter

tweets_clean <- tweets %>%
  mutate(
    date = as.Date(created_at),
    text = str_to_lower(text)
  ) %>%
  filter(!is.na(text), !is.na(date))


## Définition des dictionnaires thématiques

keywords_polarization <- c(
  "hate", "enemy", "traitor", "extreme", "radical", "division"
)

keywords_woke <- c(
  "woke", "cancel", "identity", "privilege", "oppression", "racism", "gender"
)

keywords_crisis <- c(
  "inflation", "prices", "unemployment", "recession", "crisis", "poverty", "cost"
)

keywords_authoritarian <- c(
  "authoritarian", "dictator", "control", "surveillance", "freedom"
)

keywords_information <- c(
  "media", "fake", "propaganda", "truth", "misinformation", "censorship", "news"
)

keywords_green_pro <- c(
  "climate", "environment", "green", "renewable", "sustainability", "ecology",
  "carbon", "transition"
)

keywords_green_anti <- c(
  "climatehoax"
)

keywords_repression <- c(
  "police", "repression", "violence"
)


## Construction du dictionnaire idéologique

dictionary <- tibble(
  word = c(
    keywords_polarization,
    keywords_woke,
    keywords_crisis,
    keywords_authoritarian,
    keywords_information,
    keywords_green_pro,
    keywords_green_anti,
    keywords_repression
  ),
  category = c(
    rep("polarization", length(keywords_polarization)),
    rep("woke", length(keywords_woke)),
    rep("economic_crisis", length(keywords_crisis)),
    rep("authoritarian", length(keywords_authoritarian)),
    rep("information", length(keywords_information)),
    rep("green_pro", length(keywords_green_pro)),
    rep("green_anti", length(keywords_green_anti)),
    rep("repression", length(keywords_repression))
  ),
  ideology = c(
    rep("gauche", 6),
    rep("gauche", 7),
    rep("centre", 7),
    rep("droite", 5),
    rep("centre", 7),
    rep("gauche", 8),
    rep("droite", 1),
    rep("droite", 3)
  )
)

## Tokenisation du texte

tweets_tokens <- tweets_clean %>%
  unnest_tokens(word, text)

## Identification des mots idéologiques

tweets_ideology <- tweets_tokens %>%
  inner_join(dictionary, by = "word")

## Comptage gauche vs droite

ideology_daily <- tweets_ideology %>%
  count(date, ideology) %>%
  complete(
    date,
    ideology = c("gauche", "droite"),
    fill = list(n = 0)
  )

## Construction de l’indicateur de polarisation

polarization_daily <- ideology_daily %>%
  pivot_wider(
    names_from = ideology,
    values_from = n
  ) %>%
  mutate(
    polarization = abs(gauche - droite) / (gauche + droite + 1)
  )

## Passage au niveau mensuel

polarization_monthly <- polarization_daily %>%
  mutate(month = floor_date(date, "month")) %>%
  group_by(month) %>%
  summarise(
    polarization = mean(polarization, na.rm = TRUE)
  )

## Importation des données macroéconomiques (FRED)

getSymbols(c("CPIAUCSL", "UNRATE"), src = "FRED")
inflation_df <- tibble(
  month = as.Date(index(CPIAUCSL)),
  inflation = as.numeric(coredata(CPIAUCSL))
)

unemployment_df <- tibble(
  month = as.Date(index(UNRATE)),
  unemployment = as.numeric(coredata(UNRATE))
)

macro <- inflation_df %>%
  inner_join(unemployment_df, by = "month")

## Fusion discours-macroéconomie

final_data <- polarization_monthly %>%
  left_join(macro, by = "month") %>%
  drop_na()

## Régression économétrique

model <- lm(
  polarization ~ inflation + unemployment,
  data = final_data
)

summary(model)

## Visualisation conjointe

ggplot(final_data, aes(x = month)) +
  geom_line(aes(y = polarization), color = "red", linewidth = 1) +
  geom_line(aes(y = scale(inflation)), linetype = "dashed", linewidth = 1) +
  theme_minimal() +
  labs(
    title = "Polarisation idéologique sur Twitter et tensions macroéconomiques",
    subtitle = "Indice basé sur un dictionnaire idéologique thématique",
    y = "Valeurs normalisées",
    x = "Date"
  )

## Corrélations

cor_table <- final_data %>%
  select(polarization, inflation, unemployment) %>%
  cor(use = "complete.obs")
print(cor_table)

ggcorr(final_data %>% select(polarization, inflation, unemployment),
       label = TRUE, 
       label_round = 2, 
       hjust = 0.8,
       size = 5,
       low = "blue", high = "red")

